<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/jszip.js"></script>
<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script> 
<script src="https://jsuites.net/v4/jsuites.js"></script>
<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
<script src="jspreadsheet.js"></script>

<button id="save">Save</button>
<p id="status"></p>

<div id="spreadsheet"></div>
{{{script}}}

<script>
  let mainSheet = jspreadsheet(document.getElementById('spreadsheet'), {data: data});

  let save = document.getElementById('save');
  save.addEventListener('click', async () => {
    let blob = mainSheet.getBlob(undefined, mimeType);
    let base64Blob = await blobToBase64(blob);

    save.disabled = true;
    document.querySelector('#status').innerText = 'Hang tight! Saving data to salesforce...';

    fetch('/saveXlsx', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        data: mainSheet.getData(),
        ext, 
        name, 
        conDocId, 
      }),
    })
    .then(response => {
        document.querySelector('#status').innerText = 'Data saved';
        save.disabled = false;
    })
    .catch((err) => {
        document.querySelector('#status').innerText = err.message;
        save.disabled = false;
    })

  })

  function blobToBase64(blob) {
    return new Promise((resolve, _) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  }
</script>